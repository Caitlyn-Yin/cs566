import os, pandas as pd
from PIL import Image
from datasets import load_dataset
from tqdm import tqdm

ROOT = "im2latex100k"
IMGDIR = os.path.join(ROOT, "formula_images_processed")
os.makedirs(IMGDIR, exist_ok=True)

ds = load_dataset("yuntian-deng/im2latex-100k")  # splits: train / val / test

def export_split(name_hf, out_csv):
    split = ds[name_hf]
    rows = []
    for i, ex in enumerate(tqdm(split, desc=f"Exporting {name_hf}")):
        # ex has: 'formula', 'filename', 'image'
        # We'll write a clean, unique filename
        fname = f"{name_hf}_{i:06d}.png"
        fpath = os.path.join(IMGDIR, fname)

        img = ex["image"]  # this is a PIL Image (PngImageFile)
        if not isinstance(img, Image.Image):
            # just in case: convert from array/dict
            img = Image.fromarray(img["array"])
        img.save(fpath)

        rows.append({"image": fname, "formula": ex["formula"]})

    pd.DataFrame(rows).to_csv(os.path.join(ROOT, out_csv), index=False)

os.makedirs(ROOT, exist_ok=True)
export_split("train", "im2latex_train.csv")
export_split("val",   "im2latex_validate.csv")
export_split("test",  "im2latex_test.csv")

print("\nDone. Folder structure:")
print(f"- {ROOT}/")
print("  - im2latex_train.csv")
print("  - im2latex_validate.csv")
print("  - im2latex_test.csv")
print("  - formula_images_processed/  (images)")
